# Стратегия тестирования: E2E vs. Интеграционные тесты

## Введение

В ходе разработки мы столкнулись с задачей тестирования пользовательских сценариев. Изначально для этого использовались исключительно E2E-тесты на Playwright. Однако, после детального анализа мы пришли к выводу, что часть этих тестов можно и нужно заменить на более быстрые и надежные интеграционные тесты с использованием React Testing Library (RTL) и Vitest.

Этот документ фиксирует наше понимание этих двух видов тестов, их различия и стратегию, по которой мы принимаем решение о преобразовании E2E-теста в интеграционный.

## Определения и диаграммы

Ключевое различие между тестами — в их **масштабе** и **изоляции**.

### End-to-End (E2E) тесты

E2E-тест эмулирует полного путь пользователя через приложение в реальном браузере. В "идеальном" мире это включает и взаимодействие с реальным бэкендом.

```mermaid
graph TD
    A[Пользователь в браузере<br/>(эмулируется Playwright)] --> B{Frontend-приложение};
    B --> C[Backend API];
    C --> D[(База данных)];
    D --> C;
    C --> B;
    B --> A;
```

В нашем проекте мы используем более прагматичный подход, который можно назвать **"E2E-тесты фронтенд-приложения"**. Мы по-прежнему запускаем реальный браузер, но изолируем фронтенд от бэкенда, подменяя ответы API (мокируя их).

```mermaid
graph TD
    A[Пользователь в браузере<br/>(эмулируется Playwright)] --> B{Frontend-приложение};
    B --> C{<br>Mock API<br>(Перехватчики Playwright)<br>};
    C --> B;
    B --> A;
```

### Интеграционные тесты

Интеграционный тест проверяет, как несколько компонентов (или хуков, сторов) работают **вместе**, но делает это без запуска браузера. Вместо этого используется эмулированная среда `jsdom`, а компоненты рендерятся в виртуальный DOM.

```mermaid
graph TD
    subgraph "Тестовая среда (Vitest + JSDOM)"
        A["Код теста"] --> B("render");
        B --> C{"Компонент A"};
        C --> D["Компонент B"];
        C --> E["Хук/Стор"];
        A -.-> F("fireEvent/userEvent");
        F -.-> C;
        A --> G("expect");
        G -- "проверяет" --> C;
    end
```

## Сравнительная таблица

| Критерий | E2E-тесты (Playwright) | Интеграционные тесты (RTL) |
| :--- | :--- | :--- |
| **Область** | Всё приложение в сборе, включая CSS и рендеринг в браузере. | Несколько связанных компонентов и их логика. |
| **Скорость** | Медленно (секунды на тест). | Очень быстро (миллисекунды на тест). |
| **Надежность** | Низкая (часто ломаются из-за анимаций, таймингов, flaky). | Высокая (стабильны, выполняются в одной среде). |
| **Стоимость** | Высокая (сложно писать, долго отлаживать, требуют поддержки). | Низкая (легко писать и отлаживать). |
| **Уверенность** | **Высочайшая.** Дают максимальную уверенность, что всё работает для пользователя. | Высокая. Дают уверенность, что компоненты правильно работают вместе. |

## Наша стратегия: когда переписывать E2E в интеграционные?

Мы используем E2E-тесты только для проверки **самых критичных, сквозных путей пользователя**, которые невозможно или очень сложно проверить на более низком уровне.

Главный вопрос, который мы себе задаем:
> **"Проверяет ли этот тест что-то, что можно проверить, ТОЛЬКО запустив реальный браузер?"**

Если ответ "нет", то тест является кандидатом на преобразование в интеграционный.

**Примеры:**
*   Проверка сложной логики валидации формы. ➡️ **Интеграционный тест.**
*   Проверка, что после загрузки файла и ответа от (замоканного) API данные корректно отобразились в нескольких частях интерфейса. ➡️ **Интеграционный тест.**
*   Проверка, что при клике на элемент открывается модальное окно и в нем есть нужный текст. ➡️ **Интеграционный тест.**
*   Проверка, что вся страница корректно рендерится, все стили применились, и нет визуальных дефектов. ➡️ **Скриншотный тест (разновидность E2E).**
*   Проверка полного сценария: Логин -> Переход на страницу -> Загрузка файла -> Выход. ➡️ **E2E-тест.**

## Стратегия скриншот-тестирования: от страниц к областям

Изначально для визуального регрессионного тестирования использовались скриншоты целых страниц (`fullPage: true`). Этот подход имеет серьезный недостаток: **хрупкость**. Любое изменение в общем компоненте (например, в `Header`) приводило к падению всех скриншот-тестов на всех страницах, даже если основное содержимое не менялось.

Чтобы повысить стабильность и точность тестов, мы перешли к **скриншотам ключевых областей**.

**Принцип:**
Вместо того чтобы делать один большой снимок всей страницы, мы делаем несколько маленьких, сфокусированных снимков только тех ее частей, состояние которых мы хотим проверить.

**Преимущества:**
*   **Стабильность:** Тесты перестают падать из-за изменений в нерелевантных частях страницы. Тест падает только тогда, когда меняется именно та секция, за которую он отвечает.
*   **Точность:** В случае падения теста мы сразу видим, какая именно часть страницы сломалась, а не просто "что-то на странице поменялось".
*   **Скорость:** Сравнение небольших изображений происходит быстрее.

**Пример реализации (`HomePage`):**
*   **Состояние по умолчанию:** Делается скриншот только секции загрузки файла (`FileUploadSection`).
*   **Состояние с результатами:** Делается скриншот только секции с "хайлайтами" (`HighlightsSection`).
*   **Состояние с ошибкой:** Делается скриншот секции загрузки файла, которая теперь содержит сообщение об ошибке.

**Исключение из правил:**
В редких случаях, когда "состояние" относится ко всей странице (например, "пустая страница истории", где ключевым является отсутствие списка), допустимо делать скриншот всей страницы.

Этот подход позволяет нам сохранить уверенность в корректности отображения UI, значительно повысив при этом надежность и удобство поддержки тестов.

## Аудит существующих тестов

| E2E Тест-кейс (было) | Анализ | Решение |
| :--- | :--- | :--- |
| `TC-HP-003`: Ошибка при загрузке файла неверного формата. | Проверяет не только логику, но и **корректное отображение** UI ошибки (стили, компоненты). Это важный визуальный аспект. | **Оставлен как скриншот-тест.** |
| `TC-HP-001`: Успешная загрузка файла и отображение его имени. | Аналогично. Проверяет интеграцию компонентов `Dropzone`, `HomePage` и стора. | **Преобразован в интеграционный.** |
| `TC-HP-002`: Отправка файла на обработку и отображение хайлайтов. | Проверяет взаимодействие со стором и асинхронной логикой. Зависит от моков API. Идеальный кандидат. | **Преобразован в интеграционный.** |

Таким образом, мы оставляем E2E-тесты для самых важных сквозных сценариев и визуальных проверок, а большую часть проверок взаимодействия компонентов переносим на уровень интеграционных тестов, выигрывая в скорости и надежности.

## Доступные тестовые скрипты

После оптимизации тестовой инфраструктуры, мы оставили только самые необходимые скрипты:

| Скрипт | Описание |
| :--- | :--- |
| `test:functional` | Запуск функциональных E2E-тестов из директории `tests/functional/`. |
| `test:screenshots` | Запуск скриншот-тестов из директории `tests/screenshots/`. |
| `test:e2e:ui` | Запуск тестов в интерактивном UI-режиме Playwright для удобной отладки. |
| `test:unit` | Запуск юнит-тестов с помощью Vitest. |
| `test:flaky "<pattern>" <count>` | Запуск проверки на нестабильность тестов, соответствующих шаблону. Запускает каждый тест указанное количество раз. |
| `test:flaky:all` | Запуск проверки на нестабильность всех тестов (20 прогонов). При первом падении выполнение прерывается. |
| `test:storybook` | Запуск тестов Storybook для UI-компонентов. |
| `test:storybook:snapshot` | Запуск скриншот-тестов Storybook для проверки визуальной регрессии. |
| `storybook` | Запуск Storybook в режиме разработки для работы с UI-компонентами. |

**Важно:** Тесты UI-компонентов (`@shri/ui-kit`) запускаются через скрипты внутри самого пакета. Обратитесь к документации пакета для подробностей. 