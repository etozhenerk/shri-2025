# Руководство по работе с нестабильными тестами

## Введение

Нестабильные (flaky) тесты - это тесты, которые могут как проходить, так и падать при одних и тех же входных данных. Такие тесты снижают доверие к тестовому набору и усложняют разработку. В этом руководстве описаны инструменты и практики для выявления и исправления нестабильных тестов.

## Инструменты

### test:flaky

Команда `test:flaky` позволяет запустить конкретный тест или группу тестов несколько раз для выявления нестабильности. Команда работает только с функциональными и скриншот-тестами из директорий `tests/functional` и `tests/screenshots`.

Использование:
```bash
npm run test:flaky "<шаблон_теста>" <количество_повторений>
```

Пример:
```bash
npm run test:flaky "TC-HP-005" 20  # Запустит тест TC-HP-005 20 раз
```

### test:flaky:all

Команда `test:flaky:all` запускает все тесты указанное количество раз. Как и `test:flaky`, работает только с функциональными и скриншот-тестами.

Использование:
```bash
npm run test:flaky:all <количество_повторений>
```

Пример:
```bash
npm run test:flaky:all 10  # Запустит все тесты 10 раз
```

## Рекомендации по отладке нестабильных тестов

1. **Выявление нестабильности**:
   - Запустите подозрительный тест 20-30 раз с помощью `test:flaky`
   - Если тест падает хотя бы раз, он считается нестабильным

2. **Анализ причин**:
   - Проверьте таймауты и ожидания
   - Исследуйте зависимости от внешних сервисов
   - Проанализируйте состояние приложения перед тестом

3. **Исправление**:
   - Добавьте явные ожидания вместо фиксированных задержек
   - Изолируйте тест от внешних зависимостей
   - Убедитесь в корректной очистке состояния

4. **Проверка исправлений**:
   - После исправления запустите тест минимум 50 раз
   - Убедитесь, что все прогоны успешны

## Профилактика

1. Регулярно запускайте `test:flaky:all` на CI
2. Помечайте нестабильные тесты тегом `@flaky` до исправления
3. Ведите учет выявленных проблем и их решений

## Дополнительные материалы

- [Playwright Test Retry](https://playwright.dev/docs/test-retries)
- [Best Practices for Flaky Tests](https://docs.cypress.io/guides/guides/test-flake-best-practices) 