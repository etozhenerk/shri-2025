# Руководство по написанию E2E-тестов (Playwright)

Этот документ — свод правил и лучших практик для написания автоматизированных E2E-тестов. **Все общие правила, включая процесс "Documentation-First", архитектуру POM и структуру тестов, описаны в [главном документе по конвенциям](../02_coding_conventions.md).** Здесь описаны только технические аспекты, специфичные для Playwright.

Playwright также используется для **скриншотного тестирования**. Подробные правила и техники для этого вида тестов описаны в [соответствующем руководстве](./05_screenshot_testing_guide.md).

## 1. Архитектура и утилиты

### Фикстуры (`/tests/support/fixtures.ts`)
-   **Назначение:** Механизм Playwright, который подготавливает и предоставляет в каждый тест готовые к использованию объекты (`pages`, `actions`, `mocker`).
-   **Правило №1:** Для избежания проблем с выводом типов в TypeScript, мы используем **явное (ручное)** создание экземпляров `Page` и `Action`.
-   **Правило №2:** Всегда используйте деструктуризацию фикстур в объявлении теста. Не создавайте экземпляры `...Actions` или `...Page` вручную.
-   **Правило №3:** Сложные типы для фикстур (`Pages`, `Actions`, `MyFixtures`) вынесены в отдельный файл `tests/support/types.ts`, чтобы избежать циклических зависимостей.

### Моки (`/tests/mocks/mocker.ts`)
-   **Назначение:** Класс `Mocker` для перехвата и мокирования сетевых запросов.
-   **Правило №1:** При мокировании API-запросов используйте **glob-паттерны** для URL (`**/api/endpoint*`), чтобы избежать хрупкости тестов.
-   **Правило №2:** JSON-файлы с данными для моков должны храниться в директории `/tests/test-data/mocks`.

## 2. Специфичные правила написания тестов

### Работа с анимациями
-   **Проблема:** Ожидание исчезновения анимированных элементов (например, модальных окон) может быть нестабильным.
-   **Решение:** Проверять конечное состояние CSS-свойства, которое изменяется в ходе анимации.
-   **Пример (ожидание закрытия модального окна):**
    ```typescript
    await expect(pages.historyModal.modalContainer).toHaveCSS('opacity', '0');
    ```

## 3. Конфигурация
### `playwright.config.ts`
- **`testDir`**: Должен указывать на директорию с тестами: `testDir: './tests'`.
- **`webServer`**: Должен быть настроен для автоматического запуска dev-сервера перед тестами.

## 4. Запуск тестов

Для запуска E2E и скриншотных тестов предусмотрены следующие скрипты:

-   `npm run test:e2e` — запускает все тесты Playwright (и функциональные, и скриншотные).
-   `npm run test:functional` — запускает только функциональные тесты.
-   `npm run test:screenshots` — запускает только скриншотные тесты.
-   `npm run test:ui` — запускает Playwright в интерактивном UI-режиме.
-   `npm run test:debug` — запускает Playwright в режиме отладки.

### Стабильность тестов (Flaky Tests)
Для выявления нестабильных ("flaky") тестов используйте встроенные скрипты.
-   **Проверка одного теста:** `npm run test:flaky -- --testName="имя теста" --repeats=10`
-   **Проверка всех тестов:** `npm run test:flaky:all -- --repeats=5` 