# Cookbook: Рецепты написания тестов

Этот документ — свод правил и лучших практик ("memory bank") для написания автоматизированных тестов в нашем проекте. Его цель — обеспечить единообразие, стабильность и читаемость тестового кода.

## 1. Архитектура тестов

Наша архитектура основана на **Page Object Model (POM)** с четким разделением ответственности.

### Page Objects (`/tests/page-objects`)

-   **Назначение:** Представление страниц или переиспользуемых UI-компонентов.
-   **Правило:** Содержат **только геттеры для локаторов** элементов. В них не должно быть никакой логики взаимодействия (кликов, проверок и т.д.).
-   **Пример:**
    ```typescript
    // tests/page-objects/pages/homePage.ts
    export class HomePage extends BasePage {
        get uploadButton() {
            return this.page.getByTestId('home-page-upload-button');
        }
    }
    ```

### Actions (`/tests/actions`)

-   **Назначение:** Инкапсуляция пользовательских сценариев и взаимодействия с элементами.
-   **Правило №1:** **НИКОГДА** не должны содержать `expect`. Все проверки (`assert`/`expect`) должны находиться исключительно в теле теста (`*.spec.ts`).
-   **Правило №2:** Действия, работающие с состоянием браузера (например, `localStorage`), должны быть самодостаточными. Они должны сами переходить на нужную страницу (`goto`) перед манипуляциями с хранилищем.
-   **Пример:**
    ```typescript
    // tests/actions/historyActions.ts
    export class HistoryActions {
        async seedHistory(history: HistoryItem[]) {
            // Самостоятельно переходим на страницу
            await this.pages.history.goto();
            // Выполняем действие
            await this.pages.history.page.evaluate((h) => {
                localStorage.setItem('history', JSON.stringify(h));
            }, history);
            // Перезагружаем для применения состояния
            await this.pages.history.page.reload();
        }
    }
    ```

### Фикстуры (`/tests/support/fixtures.ts`)

-   **Назначение:** Механизм Playwright, который подготавливает и предоставляет в каждый тест готовые к использованию объекты (`pages`, `actions`, `mocker`).
-   **Правило:** Всегда используйте деструктуризацию фикстур в объявлении теста для получения доступа к нашим архитектурным компонентам. Не создавайте экземпляры `...Actions` или `...Page` вручную.
-   **Пример:**
    ```typescript
    test('Пример использования фикстур', async ({ pages, actions, mocker }) => {
      // ...
    });
    ```

### Моки (`/tests/mocks/mocker.ts`)

-   **Назнашение:** Класс `Mocker` для перехвата и мокирования сетевых запросов.
-   **Правило:** При мокировании API-запросов используйте **glob-паттерны** для URL (`**/api/endpoint*`), чтобы избежать хрупкости тестов из-за изменения query-параметров.

## 2. Правила написания тестовых сценариев (`*.spec.ts`)

### Структура теста

-   **Правило №1:** Всегда структурируйте тело теста с помощью `test.step('Описание шага', async () => { ... });`.
-   **Правило №2:** Каждый `test.step`, выполняющий пользовательское действие, **обязательно** должен содержать в себе проверку (`expect`), которая подтверждает результат этого действия.
-   **Правило №3:** Предусловия теста (мокирование, подготовка данных) должны выполняться до `test.step`, в `test.beforeEach` или в самом начале тела теста.

### Работа с локаторами

-   **Правило:** **ЗАПРЕЩЕНО** использовать "голые" локаторы (`page.getByTestId(...)`) в файлах спеков. Всегда получайте локаторы из `Page Objects` через фикстуру `pages`.

### Работа с анимациями

-   **Проблема:** Ожидание исчезновения анимированных элементов (например, модальных окон) может быть нестабильным.
-   **Ненадежные подходы:** `not.toBeInViewport()`, ожидание удаления CSS-класса.
-   **Надежное решение:** Проверять конечное состояние CSS-свойства, которое изменяется в ходе анимации.
-   **Пример (ожидание закрытия модального окна):**
    ```typescript
    await test.step('Шаг 2: Закрыть модальное окно и убедиться, что оно скрыто', async () => {
        await actions.history.closeModal();
        // Проверяем, что окно стало полностью прозрачным после анимации
        await expect(pages.historyModal.modalContainer).toHaveCSS('opacity', '0');
    });
    ```

## 3. Стабильность тестов (Flaky Tests)

Для выявления нестабильных ("flaky") тестов используйте встроенные скрипты.

-   **Проверка одного теста:** `npm run test:flaky -- --testName="имя теста" --repeats=10`
-   **Проверка всех тестов:** `npm run test:flaky:all -- --repeats=5`

## 4. Юнит-тесты (Vitest)

-   **Расположение:** Файлы unit-тестов должны находиться в директории `src` рядом с тестируемым модулем и иметь суффикс `.test.ts` или `.test.tsx`.
-   **Язык:** Все описания (`describe`, `it`) должны быть на **русском языке**. 