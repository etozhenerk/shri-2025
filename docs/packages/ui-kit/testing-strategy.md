# Стратегия тестирования UI-компонентов

## Введение

В ходе аудита текущего тестового покрытия было выявлено, что компоненты из директории `src/ui` (наш UI-кит) не покрыты тестами. Существующие E2E и интеграционные тесты проверяют эти компоненты только косвенно, в рамках пользовательских сценариев.

Такой подход не позволяет:
1.  **Тестировать компоненты в изоляции:** Проверять все возможные состояния и вариации компонента (например, `disabled`, `error`, `loading`).
2.  **Эффективно отлавливать визуальные регрессии:** Изменения в стилях компонента могут остаться незамеченными, если они не ломают основной функционал.

Для решения этих проблем мы внедряем выделенную стратегию тестирования для UI-кита, основанную на скриншот-тестировании.

## Выбор инструмента

Мы рассмотрели два основных инструмента для компонентного тестирования: **Playwright Component Tests** и **Storybook**.

| Критерий | Playwright Component Tests | Storybook | Выбор |
| :--- | :--- | :--- | :---: |
| **Основная цель** | Функциональное и визуальное тестирование компонентов в изоляции. | Разработка, демонстрация и визуальное тестирование компонентов в интерактивной среде. | ✅ |
| **Интеграция** | Глубокая интеграция с существующей конфигурацией Playwright. | Требует отдельной установки и настройки. | |
| **Инфраструктура** | Использует тот же движок и API, что и E2E-тесты. | Предоставляет отдельный UI (песочницу) для разработки и просмотра компонентов. | ✅ |
| **DX (Developer Experience)** | Быстрый и привычный для команды, уже работающей с Playwright. | **Более наглядный.** Позволяет интерактивно взаимодействовать с компонентами, что полезно для демонстрации и ручного тестирования. | ✅ |
| **Экосистема** | Меньше плагинов, сфокусирован на тестировании. | Огромная экосистема аддонов для документации, тестирования доступности, проверки пропсов и т.д. | ✅ |
| **Стоимость внедрения** | Низкая, если Playwright уже настроен. | Средняя, требует установки нескольких пакетов и создания конфигурационных файлов. | |

## Решение

Несмотря на то, что Playwright Component Tests был бы проще в интеграции, мы выбрали **Storybook**.

**Ключевая причина:** Storybook предоставляет интерактивную "песочницу" для UI-компонентов. Это не только решает задачу визуального регрессионного тестирования, но и значительно улучшает процесс разработки и демонстрации компонентов. Возможность в реальном времени видеть все состояния компонента и взаимодействовать с ними является фундаментальным преимуществом для нашего проекта. Мы готовы пойти на дополнительные затраты по внедрению ради этих преимуществ.

## Практическая реализация (Playwright + Storybook)

Для автоматизации снятия скриншотов из Storybook мы используем Playwright.

### Структура и расположение файлов

Ключевой принцип — **колокация**. Все, что относится к компоненту, должно лежать рядом с ним внутри пакета `@shri/ui-kit`.

-   **Пакет**: `packages/ui-kit/`
    -   **Компонент**: `src/Button/Button.tsx`
    -   **История Storybook**: `src/Button/__stories__/Button.stories.tsx`
    -   **UI-снэпшот тест**: `__tests__/Button.spec.ts`

### Именование и теги

-   **Именование файлов**: Имя тестового файла должно соответствовать имени компонента и иметь суффикс `.spec.ts`.
-   **Тег для тестов**: Каждый тест должен иметь тег `@ui-snapshot` в названии, чтобы Playwright мог их выборочно запускать.

### Архитектура (PO и Actions)

Тесты строго следуют паттерну Page Object (PO) и Actions. Эти утилиты предоставляются пакетом `@shri/playwright`. Созданы специальные `storybookPage` и `storybookActions` для инкапсуляции логики взаимодействия со Storybook.

### Пример теста

Тесты должны быть простыми и декларативными. Каждый тест отвечает за проверку одного конкретного состояния компонента.

```typescript
import { test, expect } from '@shri/playwright';

test('Компонент Button, состояние: primary @ui-snapshot', async ({ actions, pages }) => {
  // Arrange
  await actions.storybook.openStory('ui-button--primary');

  // Act
  await expect(pages.storybook.component).toBeVisible();

  // Assert
  await expect(pages.storybook.component).toHaveScreenshot('button-primary.png');
});
```

### Запуск тестов

Для запуска всех UI-снэпшот тестов используется команда:

```bash
npm run test:ui-snapshot
``` 