# Свод правил по написанию тестов

Этот документ — свод правил и лучших практик ("memory bank") для написания автоматизированных тестов в нашем проекте. Его цель — обеспечить единообразие, стабильность и читаемость тестового кода.

## 1. Архитектура тестов

Наша архитектура основана на **Page Object Model (POM)** с четким разделением ответственности. Каждый компонент имеет "реестр" (`index.ts`), который экспортирует все классы для их динамического использования в фикстурах.

### Page Objects (`/tests/page-objects`)

-   **Назначение:** Представление страниц или переиспользуемых UI-компонентов.
-   **Правило:** Содержат **только геттеры для локаторов** элементов. В них не должно быть никакой логики взаимодействия (кликов, проверок и т.д.). Все Page Objects наследуются от `BasePage`.
-   **Пример:**
    ```typescript
    // tests/page-objects/pages/homePage.ts
    export class HomePage extends BasePage {
        get uploadButton() {
            return this.page.getByTestId('home-page-upload-button');
        }
    }
    ```

### Actions (`/tests/actions`)

-   **Назначение:** Инкапсуляция пользовательских сценариев и взаимодействия с элементами.
-   **Правило №1:** **НИКОГДА** не должны содержать `expect`. Все проверки (`assert`/`expect`) должны находиться исключительно в теле теста (`*.spec.ts`).
-   **Правило №2:** Конструктор каждого класса Actions должен принимать в качестве аргумента объект `pages`, чтобы иметь доступ к локаторам.
-   **Правило №3:** Действия, работающие с состоянием браузера (например, `localStorage`), должны быть самодостаточными. Они должны сами переходить на нужную страницу (`goto`) перед манипуляциями с хранилищем, используя `this.pages`.
-   **Пример:**
    ```typescript
    // tests/actions/historyActions.ts
    export class HistoryActions {
        constructor(private readonly pages: Pages) {} // `pages` передаются фикстурой

        async seedHistory(history: HistoryItem[]) {
            // Самостоятельно переходим на страницу
            await this.pages.history.goto();
            // Выполняем действие
            await this.pages.history.page.evaluate((h) => {
                localStorage.setItem('history', JSON.stringify(h));
            }, history);
            // Перезагружаем для применения состояния
            await this.pages.history.page.reload();
        }
    }
    ```

### Фикстуры (`/tests/support/fixtures.ts`)

-   **Назначение:** Механизм Playwright, который подготавливает и предоставляет в каждый тест готовые к использованию объекты (`pages`, `actions`, `mocker`).
-   **Правило №1:** Для избежания проблем с выводом типов в TypeScript, мы используем **явное (ручное)** создание экземпляров `Page` и `Action`. Это обеспечивает надежность и предсказуемость типов.
-   **Правило №2:** Фикстура `actions` **обязательно** должна зависеть от фикстур `page` и `pages`. Экземпляры `Actions` должны создаваться с передачей им этих объектов: `new YourAction(page, pages)`.
-   **Правило №3:** Всегда используйте деструктуризацию фикстур в объявлении теста. Не создавайте экземпляры `...Actions` или `...Page` вручную.
-   **Правило №4:** Сложные типы для фикстур (`Pages`, `Actions`, `MyFixtures`) вынесены в отдельный файл `tests/support/types.ts`, чтобы избежать циклических зависимостей.
-   **Пример реализации фикстуры:**
    ```typescript
    // tests/support/fixtures.ts
    test.extend<MyFixtures>({
        pages: async ({ page }, use) => {
            const pages = {
                home: new pageClasses.home(page),
                generate: new pageClasses.generate(page),
                history: new pageClasses.history(page),
            };
            await use(pages);
        },
        actions: async ({ page, pages }, use) => { // Зависимость от page и pages
            const actions = {
                home: new actionClasses.home(page, pages),
                generate: new actionClasses.generate(page, pages),
                history: new actionClasses.history(page, pages),
            };
            await use(actions);
        },
        // ...
    });
    ```

### Моки (`/tests/mocks/mocker.ts`)

-   **Назнашение:** Класс `Mocker` для перехвата и мокирования сетевых запросов.
-   **Правило №1:** При мокировании API-запросов используйте **glob-паттерны** для URL (`**/api/endpoint*`), чтобы избежать хрупкости тестов из-за изменения query-параметров.
-   **Правило №2:** JSON-файлы с данными для моков должны храниться в директории `/tests/test-data/mocks`.

## 2. Правила написания тестовых сценариев (`*.spec.ts`)

### Расположение файлов
- **Правило:** Все файлы с e2e-тестами (`*.spec.ts`) должны находиться строго в директории `tests/specs/`.

### Структура теста

-   **Правило №1:** Всегда структурируйте тело теста с помощью `test.step('Описание шага', async () => { ... });`.
-   **Правило №2:** Каждый `test.step`, выполняющий пользовательское действие, **обязательно** должен содержать в себе проверку (`expect`), которая подтверждает результат этого действия.
-   **Правило №3:** Предусловия теста (мокирование, подготовка данных) должны выполняться до `test.step`, в `test.beforeEach` или в самом начале тела теста.

### Работа с локаторами

-   **Правило:** **ЗАПРЕЩЕНО** использовать "голые" локаторы (`page.getByTestId(...)`) в файлах спеков. Всегда получайте локаторы из `Page Objects` через фикстуру `pages`.

### Работа с анимациями

-   **Проблема:** Ожидание исчезновения анимированных элементов (например, модальных окон) может быть нестабильным.
-   **Решение:** Проверять конечное состояние CSS-свойства, которое изменяется в ходе анимации.
-   **Пример (ожидание закрытия модального окна):**
    ```typescript
    await test.step('Шаг 2: Закрыть модальное окно и убедиться, что оно скрыто', async () => {
        await actions.history.closeModal();
        // Проверяем, что окно стало полностью прозрачным после анимации
        await expect(pages.historyModal.modalContainer).toHaveCSS('opacity', '0');
    });
    ```
    
## 3. Конфигурационные файлы

### `playwright.config.ts`
- **`testDir`**: Должен указывать строго на директорию со спеками: `testDir: './tests/specs'`.
- **`webServer`**: Должен быть настроен для автоматического запуска dev-сервера перед тестами.

### `vitest.config.ts`
- **`include`**: Должен включать только файлы из `src` с суффиксами `.test.ts` / `.spec.ts`: `include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}']`.
- **`exclude`**: Должен исключать директорию `tests` и другие нерелевантные файлы: `exclude: ['tests/**']`.
- **`setupFiles`**: Должен указывать на файл с глобальными настройками для тестов, например: `setupFiles: 'tests/setup.ts'`.

## 4. Стабильность тестов (Flaky Tests)

Для выявления нестабильных ("flaky") тестов используйте встроенные скрипты.

-   **Проверка одного теста:** `npm run test:flaky -- --testName="имя теста" --repeats=10`
-   **Проверка всех тестов:** `npm run test:flaky:all -- --repeats=5`

## 5. Юнит-тесты (Vitest)

-   **Расположение:** Для поддержания порядка, файлы unit-тестов должны находиться в специальной поддиректории `__tests__` внутри папки с тестируемым модулем (например, `src/utils/__tests__/`).
-   **Язык:** Все описания (`describe`, `it`) должны быть на **русском языке**. 